<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="wc.dao.ITbCrmBusinessDao">
  <resultMap id="BaseResultMap" type="wc.entity.TbCrmBusiness">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="ID" jdbcType="DECIMAL" property="id" />
    <result column="NAME" jdbcType="VARCHAR" property="name" />
    <result column="ORIGIN" jdbcType="VARCHAR" property="origin" />
    <result column="TYPE" jdbcType="VARCHAR" property="type" />
    <result column="ESTIMATE_PRICE" jdbcType="DECIMAL" property="estimatePrice" />
    <result column="CUSTOMER_ID" jdbcType="DECIMAL" property="customerId" />
    <result column="CREATOT_USER_ID" jdbcType="DECIMAL" property="creatotUserId" />
    <result column="OWNER_USER_ID" jdbcType="DECIMAL" property="ownerUserId" />
    <result column="GAIN_RATE" jdbcType="DECIMAL" property="gainRate" />
    <result column="TOTAL_AMOUNT" jdbcType="DECIMAL" property="totalAmount" />
    <result column="SUBTOTAL_VAL" jdbcType="DECIMAL" property="subtotalVal" />
    <result column="DISCOUNT_PRICE" jdbcType="DECIMAL" property="discountPrice" />
    <result column="SALES_PRICE" jdbcType="DECIMAL" property="salesPrice" />
    <result column="CREATE_TIME" jdbcType="TIMESTAMP" property="createTime" />
    <result column="UPDATE_TIME" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="UPDATE_USER_ID" jdbcType="DECIMAL" property="updateUserId" />
    <result column="STATUS_ID" jdbcType="DECIMAL" property="statusId" />
    <result column="TOTAL_PRICE" jdbcType="DECIMAL" property="totalPrice" />
    <result column="NEXTSTEP" jdbcType="VARCHAR" property="nextstep" />
    <result column="NEXTSTEP_TIME" jdbcType="TIMESTAMP" property="nextstepTime" />
    <result column="DELETE_STATUS" jdbcType="DECIMAL" property="deleteStatus" />
    <result column="DELETE_USER_ID" jdbcType="DECIMAL" property="deleteUserId" />
    <result column="DELETE_TIME" jdbcType="TIMESTAMP" property="deleteTime" />
    <result column="CONTACTS_ID" jdbcType="DECIMAL" property="contactsId" />
    <result column="CONTRACT_ADDRESS" jdbcType="VARCHAR" property="contractAddress" />
    <result column="DESCRPTION" jdbcType="VARCHAR" property="descrption" />
    <result column="DUE_DATE" jdbcType="TIMESTAMP" property="dueTime" />
  </resultMap>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from TB_CRM_BUSINESS
    where ID = #{id,jdbcType=DECIMAL}
  </delete>
  <insert id="insert" parameterType="wc.entity.TbCrmBusiness">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into TB_CRM_BUSINESS (ID, NAME, ORIGIN, 
      TYPE, ESTIMATE_PRICE, CUSTOMER_ID, 
      CREATOT_USER_ID, OWNER_USER_ID, GAIN_RATE, 
      TOTAL_AMOUNT, SUBTOTAL_VAL, DISCOUNT_PRICE, 
      SALES_PRICE, CREATE_TIME, UPDATE_TIME, 
      UPDATE_USER_ID, STATUS_ID, TOTAL_PRICE, 
      NEXTSTEP, NEXTSTEP_TIME, DELETE_STATUS, 
      DELETE_USER_ID, DELETE_TIME, CONTACTS_ID, 
      CONTRACT_ADDRESS, DESCRPTION,DUE_DATE)
    values (seq_business.nextval, #{name,jdbcType=VARCHAR}, #{origin,jdbcType=VARCHAR}, 
      #{type,jdbcType=VARCHAR}, #{estimatePrice,jdbcType=DECIMAL}, #{customerId,jdbcType=DECIMAL}, 
      #{creatotUserId,jdbcType=DECIMAL}, #{ownerUserId,jdbcType=DECIMAL}, #{gainRate,jdbcType=DECIMAL}, 
      #{totalAmount,jdbcType=DECIMAL}, #{subtotalVal,jdbcType=DECIMAL}, #{discountPrice,jdbcType=DECIMAL}, #{salesPrice,jdbcType=DECIMAL}, 
      to_date(#{createTime},'yyyy-mm-dd hh24:mi:ss'),
      to_date(#{updateTime},'yyyy-mm-dd hh24:mi:ss'), 
      #{updateUserId,jdbcType=DECIMAL}, #{statusId,jdbcType=DECIMAL}, #{totalPrice,jdbcType=DECIMAL}, #{nextstep,jdbcType=VARCHAR}, 
      to_date(#{nextstepTime},'yyyy-mm-dd hh24:mi:ss'), 
      #{deleteStatus,jdbcType=DECIMAL}, #{deleteUserId,jdbcType=DECIMAL}, 
      to_date(#{deleteTime},'yyyy-mm-dd hh24:mi:ss'), 
      #{contactsId,jdbcType=DECIMAL}, #{contractAddress,jdbcType=VARCHAR}, #{descrption,jdbcType=VARCHAR}, 
      to_date(#{dueTime},'yyyy-mm-dd hh24:mi:ss'))
  </insert>
  <update id="updateByPrimaryKey" parameterType="wc.entity.TbCrmBusiness">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update TB_CRM_BUSINESS
    set NAME = #{name},
      ORIGIN = #{origin},
      TYPE = #{type},
      ESTIMATE_PRICE = #{estimatePrice},
      CUSTOMER_ID = #{customerId},
      CREATOT_USER_ID = #{creatotUserId},
      OWNER_USER_ID = #{ownerUserId},
      GAIN_RATE = #{gainRate},
      TOTAL_AMOUNT = #{totalAmount},
      SUBTOTAL_VAL = #{subtotalVal},
      DISCOUNT_PRICE = #{discountPrice},
      SALES_PRICE = #{salesPrice},
      CREATE_TIME = to_date(#{createTime},'yyyy-mm-dd hh24:mi:ss'),
      UPDATE_TIME = to_date(#{updateTime},'yyyy-mm-dd hh24:mi:ss'),
      UPDATE_USER_ID = #{updateUserId},
      STATUS_ID = #{statusId},
      TOTAL_PRICE = #{totalPrice},
      NEXTSTEP = #{nextstep},
      NEXTSTEP_TIME = to_date(#{nextstepTime},'yyyy-mm-dd hh24:mi:ss'),
      DELETE_STATUS = #{deleteStatus},
      DELETE_USER_ID = #{deleteUserId},
      DELETE_TIME = to_date(#{deleteTime},'yyyy-mm-dd hh24:mi:ss'),
      CONTACTS_ID = #{contactsId},
      CONTRACT_ADDRESS = #{contractAddress},
      DESCRPTION = #{descrption},
      DUE_DATE = to_date(#{dueTime},'yyyy-mm-dd hh24:mi:ss')
    where ID = #{id}
  </update>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select ID, NAME, ORIGIN, TYPE, ESTIMATE_PRICE, CUSTOMER_ID, CREATOT_USER_ID, OWNER_USER_ID, 
    GAIN_RATE, TOTAL_AMOUNT, SUBTOTAL_VAL, DISCOUNT_PRICE, SALES_PRICE, CREATE_TIME, 
    UPDATE_TIME, UPDATE_USER_ID, STATUS_ID, TOTAL_PRICE, NEXTSTEP, NEXTSTEP_TIME, DELETE_STATUS, 
    DELETE_USER_ID, DELETE_TIME, CONTACTS_ID, CONTRACT_ADDRESS, DESCRPTION,DUE_DATE
    from TB_CRM_BUSINESS
    where ID = #{id,jdbcType=DECIMAL}
  </select>
  <select id="selectAll" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select ID, NAME, ORIGIN, TYPE, ESTIMATE_PRICE, CUSTOMER_ID, CREATOT_USER_ID, OWNER_USER_ID, 
    GAIN_RATE, TOTAL_AMOUNT, SUBTOTAL_VAL, DISCOUNT_PRICE, SALES_PRICE, CREATE_TIME, 
    UPDATE_TIME, UPDATE_USER_ID, STATUS_ID, TOTAL_PRICE, NEXTSTEP, NEXTSTEP_TIME, DELETE_STATUS, 
    DELETE_USER_ID, DELETE_TIME, CONTACTS_ID, CONTRACT_ADDRESS, DESCRPTION,DUE_DATE
    from TB_CRM_BUSINESS
  </select>
  <select id="findByContractVO2" resultType="wc.entity.ContractVO2">
  	select 
  	tcbs.id as tcbsId,tcbs.name as tcbsName,
  	tccr.name as tccrName,tccs.name as tccsName 
  	from TB_CRM_BUSINESS tcbs ,tb_crm_customer tccr,
  	tb_crm_contacts tccs 
	where tcbs.customer_id = tccr.id and tccr.id = tccs.customer_id	
  </select>
  <select id="findByIdContractVO2" resultType="wc.entity.ContractVO2">
  	select 
  	tcbs.id as tcbsId,tcbs.name as tcbsName,
  	tccr.name as tccrName,tccs.name as tccsName 
  	from TB_CRM_BUSINESS tcbs ,tb_crm_customer tccr,
  	tb_crm_contacts tccs 
	where tcbs.customer_id = tccr.id and tccr.id = tccs.customer_id	
	and tcbs.id = #{tcbsId}
  </select>
  <!-- 这个其实没用，现在可以自动对应了~~~~~~ -->
  <resultMap id="BusinessVOMap" type="wc.entity.BusinessVO">
    <id column="ID" jdbcType="DECIMAL" property="id" />
    <result column="NAME" jdbcType="VARCHAR" property="name" />
    <result column="ORIGIN" jdbcType="VARCHAR" property="origin" />
    <result column="CUSTOMERNAME" jdbcType="VARCHAR" property="customerName" />
    <result column="NEXTSTEP_TIME" jdbcType="TIMESTAMP" property="nextstepTime" />
    <result column="NEXTSTEP" jdbcType="VARCHAR" property="nextstep" />
    <result column="CREATORNAME" jdbcType="VARCHAR" property="creatorName" />
    <result column="OWNERNAME" jdbcType="VARCHAR" property="ownerName" />
    <result column="CREATE_TIME" jdbcType="TIMESTAMP" property="createTime" />
    <result column="UPDATE_TIME" jdbcType="TIMESTAMP" property="updateTime" />
  </resultMap>
  <!-- 商机的联合模糊分页查询 -->
  <select id="findAllBusinessBy" resultType="wc.entity.BusinessVO">
  	select * from(select rownum as r,bb.* from (
  	select b.id,b.name,b.origin,b.nextstep_time,b.nextstep,
	c.name customerName,u1.username creatorName,u2.username ownerName,b.create_time,b.update_time
	from tb_crm_business b,tb_crm_customer c,tb_system_user u1,tb_system_user u2
	where b.customer_id=c.id and b.creatot_user_id=u1.user_id and b.delete_status=0
	and b.owner_user_id=u2.user_id and b.owner_user_id=${userId} order by b.id)bb 
	where rownum &lt;= #{end}
	<if test="field!=null and value!=null ">
    	and bb.${field} like '%'||#{value}||'%'
    </if>
	)bbb 
	where bbb.r&gt;#{start} order by bbb.r
  </select>
  <!-- 商机分页的行数 -->
  <select id="getAllBusinessCount" resultType="int">
  	select count(*) from(select rownum as r,bb.* from (
  	select b.id,b.name,b.origin,b.nextstep_time,b.nextstep,
	c.name customerName,u1.username creatorName,u2.username ownerName,b.create_time,b.update_time
	from tb_crm_business b,tb_crm_customer c,tb_system_user u1,tb_system_user u2
	where b.customer_id=c.id and b.creatot_user_id=u1.user_id and b.delete_status=0
	and b.owner_user_id=u2.user_id and b.owner_user_id=${userId} order by b.id)bb 
	<where>
	<if test="field!=null and value!=null ">
    	bb.${field} like '%'||#{value}||'%'
    </if>
	</where>
	)bbb 
  </select>
  
  <!-- 批量修改删除状态达到批量删除效果 -->
  <update id="updateDelete" parameterType="java.util.List" >
  	update tb_crm_business set delete_status=1,OWNER_USER_ID=null,delete_time=sysdate where id in
  		<foreach close=")" collection="list" item="id" open="(" separator=",">
			#{id}
		</foreach>
  </update>
  <!-- 修改一条达到删除效果 -->
  <update id="updateDeleteOne" parameterType="int">
  	update tb_crm_business set delete_status=1,OWNER_USER_ID=null where id=#{id}
  </update>
  
   <!-- 获取一条带负责人,客户名，联系人姓名的数据 -->
  <select id="getOneBusinessVO" parameterType="java.lang.Long" resultType="wc.entity.BusinessVO">
  	select u.username ownerName,c1.name customerName,c2.name contactsName
	from tb_crm_business b,tb_crm_customer c1,tb_crm_contacts c2,tb_system_user u
	where b.id=u.user_id and b.customer_id=c1.id and b.contacts_id=c2.id and b.id=#{id}
  </select>
  
  <!-- 分页查询商机回收站 -->
  <select id="findBusinessRB" resultType="wc.entity.BusinessVO">
  	select * from(select rownum as r,bb.* from (
  	select b.id,b.name,b.origin,b.nextstep_time,b.nextstep,
	c.name customerName,u1.username creatorName,b.create_time,b.update_time
	from tb_crm_business b,tb_crm_customer c,tb_system_user u1
	where b.customer_id=c.id and b.creatot_user_id=u1.user_id and b.delete_status=1
	and order by b.id)bb 
	where rownum &lt;= #{end}
	<if test="field!=null and value!=null ">
    	and bb.${field} like '%'||#{value}||'%'
    </if>
	)bbb 
	where bbb.r&gt;#{start} order by bbb.r
  </select>
  <!-- 回收站总行数 -->
  <select id="findBusinessRBCount" resultType="int">
  	select count(*) from(select rownum as r,bb.* from (
  	select b.id,b.name,b.origin,b.nextstep_time,b.nextstep,
	c.name customerName,u1.username creatorName,b.create_time,b.update_time
	from tb_crm_business b,tb_crm_customer c,tb_system_user u1
	where b.customer_id=c.id and b.creatot_user_id=u1.user_id and b.delete_status=1
	and order by b.id)bb 
	<where>
	<if test="field!=null and value!=null ">
    	and bb.${field} like '%'||#{value}||'%'
    </if>
	</where>
	)bbb 
	order by bbb.r
  </select>
  
  <!-- 查询所有商机日志 -->
  <select id="findBusinessLogById" resultType="java.util.HashMap">
  	select t1.*,u.username ownerName from tb_crm_business_log t1,tb_crm_business t2,tb_system_user u where t1.c_id=t2.id and t2.owner_user_id=u.user_id and t1.c_id=#{id} order by t1.id
  </select>
  <!-- 查询商机的合同 -->
  <select id="findContractById" resultType="java.util.HashMap">
  	select c.*,b.name businessName,u1.username ownerName,u2.username createName 
	from tb_crm_contract c,tb_system_user u1,tb_system_user u2,tb_crm_business b
	where c.owner_user_id=u1.user_id and c.creator_user_id=u2.user_id and c.business_id=b.id
	and c.business_id=#{id}
  </select>
  <!-- 查询一条商机的状态 -->
  <select id="getStatusIdBy" resultType="int">
  	select status_id from tb_crm_business where id=#{id}
  </select>
  <!-- 更新一条商机状态等 -->
  <update id="updateStatusBy" parameterType="wc.entity.TbCrmBusiness">
  	update tb_crm_business set STATUS_ID = #{statusId}, NEXTSTEP = #{nextstep},
      NEXTSTEP_TIME = to_date(#{nextstepTime},'yyyy-mm-dd hh24:mi:ss'),DESCRPTION = #{descrption}
      where ID = #{id}
  </update>
  
  
  <!-- 获取所有负责人名 -->
  <select id="getAllUsername" resultType="java.util.HashMap">
  	select user_id,username from tb_system_user
  </select>
  <!-- 获取所有客户名 -->
  <select id="getAllCustomerName" resultType="java.util.HashMap">
  	select id,name from tb_crm_customer 
  </select>
  <!-- 获取所有联系人名 -->
  <select id="getAllContactsName" resultType="java.util.HashMap">
  	select id,name from tb_crm_contacts
  </select>
  <!-- 根据客户id获取商机 -->
  <select id="findBNameByCId" resultType="String">
	select name from tb_crm_business where customer_id=#{id}
  </select>
  <!-- 获取联系人id -->
  <select id="getContactsId" resultType="int">
  	select id from tb_crm_contacts where name=#{name}
  </select>
  <!-- 获取客户id -->
  <select id="getCustomerId" resultType="int">
  	select id from tb_crm_customer where name=#{name}
  </select>
  
</mapper>